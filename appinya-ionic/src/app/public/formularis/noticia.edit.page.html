<!--
/**
 *  Appinya Open Source Project
 *  Copyright (C) 2021  Daniel Horta Vidal
 *
 *   This program is free software: you can redistribute it and/or modify
 *   it under the terms of the GNU Affero General Public License as
 *   published by the Free Software Foundation, either version 3 of the
 *   License, or (at your option) any later version.
 *
 *   This program is distributed in the hope that it will be useful,
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *   GNU Affero General Public License for more details.
 *
 *  You should have received a copy of the GNU Affero General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 **/  
-->
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>

    <ion-button
      slot="primary"
      [disabled]="noticiaForm?.invalid"
      shape="round"
      (click)="onSubmit()"
    >
      Guardar
    </ion-button>
  </ion-toolbar>
  <ion-toolbar>
    <ion-title
      ><ion-input
        [ngModel]="titol2"
        placeholder="Escriu el títol ..."
        (change)="canviarTitol($event)"
      ></ion-input>
    </ion-title> </ion-toolbar
></ion-header>
<ion-content *ngIf="noticiaForm"
  ><form [formGroup]="noticiaForm" (ngSubmit)="onSubmit()">
    <ion-item style="display: none">
      <ion-input placeholder="Títol" formControlName="Titol"></ion-input>
    </ion-item>

    <div
      *ngIf="Titol.invalid && (Titol.dirty || Titol.touched)"
      class="alert alert-danger"
    >
      <p class="alert-danger" *ngIf="Titol.errors.required">
        <sup>*</sup> El títol és obligatori
      </p>
    </div>
    <div id="foto-noticia">
      <img id="foto" #image [src]="Foto.value" />

      <div id="foto-agregar" (click)="grabarFoto()">Afegeix portada</div>
      <div id="foto-esborrar">
        <ion-button fill="clear" icon-only (click)="esborrarFoto()">
          <ion-icon name="trash" is-active="false"></ion-icon>
        </ion-button>
      </div>
    </div>
    <div
      *ngIf="Foto.invalid && (Foto.dirty || Foto.touched)"
      class="alert alert-danger"
    >
      <p class="alert-danger" *ngIf="Foto.errors.required">
        <sup>*</sup> La foto és obligatòria
      </p>
    </div>
    <ion-item style="display: none">
      <input
        #imageInput
        type="file"
        id="fileupload"
        accept="image/*"
        (change)="descargarFitxer(imageInput);"
      />
      <ion-button color="light">Descarregar fitxer</ion-button>
    </ion-item>

    <div>
      <p-editor
        formControlName="Descripcio"
        [style]="{'width':'100%','height':'320px'}"
      ></p-editor>
      <div
        *ngIf="Descripcio.invalid && (Descripcio.dirty || Descripcio.touched)"
      >
        <p class="alert-danger" *ngIf="Descripcio.errors.required">
          <sup>*</sup> La descripció és obligatòria
        </p>
      </div>
    </div>
    <ion-item>
      <ion-icon
        slot="start"
        color="primary"
        name="newspaper-outline"
      ></ion-icon>
      <ion-select
        formControlName="IdTipusNoticia"
        placeholder="Selecciona el tipus de notícia"
      >
        <ion-select-option
          *ngFor="let tipus of tipusNoticies"
          value="{{tipus.Id}}"
          >{{tipus.Descripcio}}</ion-select-option
        >
      </ion-select>
    </ion-item>
    <div
      *ngIf="IdTipusNoticia.invalid && (IdTipusNoticia.dirty || IdTipusNoticia.touched)"
    >
      <p class="alert-danger" *ngIf="IdTipusNoticia.errors.required">
        <sup>*</sup> El tipus de notícia és obligatori
      </p>
    </div>
    <ion-item class="opcio-data" lines="none" *ngIf="!Indefinida.value">
      <ion-icon slot="start" color="primary" name="calendar-outline"></ion-icon>
      <ion-datetime
        formControlName="Data"
        placeholder="Data caducitat"
        max="{{anyMaxim}}"
      ></ion-datetime>
    </ion-item>
    <ion-item [class.opcio-data-permanent]="!Indefinida.value">
      <ion-icon
        slot="start"
        color="primary"
        name="calendar-outline"
        *ngIf="Indefinida.value"
      ></ion-icon>

      <ion-label> Notícia permanent </ion-label>
      <ion-toggle formControlName="Indefinida" color="primary"></ion-toggle>
    </ion-item>
    <div
      *ngIf="noticiaForm.errors?.dataValidator && (Data.dirty || Data.touched)"
    >
      <p class="alert-danger">
        <sup>*</sup> És obligatori marcar la notícia com a permanent o
        assignar-li una data de caducitat
      </p>
    </div>

    <ion-item>
      <ion-icon slot="start" color="primary" name="link-outline"></ion-icon>

      <ion-input
        placeholder="Agregar un link extern"
        formControlName="Url"
      ></ion-input>
    </ion-item>
    <div *ngIf="Url.invalid && (Url.dirty || Url.touched)">
      <p class="alert-danger" *ngIf="Url.errors.pattern">
        <sup>*</sup> Url mal formatejada
      </p>
    </div>
    <ion-item *ngIf="!Nombre">
      <ion-icon slot="start" color="primary" name="person-outline"></ion-icon>
      <ion-button fill="clear" (click)="assignarResponsable()"
        >Afegeix responsable
      </ion-button>
    </ion-item>
    <ion-item *ngIf="Nombre" (click)="assignarResponsable()">
      <ion-avatar slot="start">
        <img [src]="FotoAlias" />
      </ion-avatar>
      <ion-label>
        <h3>{{Nombre}}</h3>
        <p>{{Email}}</p>
      </ion-label>
    </ion-item>

    <ion-button
      expand="full"
      color="danger"
      *ngIf="id != '0'"
      [disabled]="noticiaForm.invalid"
      (click)="esborrar()"
      ><ion-icon name="trash-bin-outline" class="mitja"></ion-icon>
      Esborrar
    </ion-button>
  </form>
</ion-content>
